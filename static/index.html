<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>手机光标控制器</title>
<style>
  body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; height:100vh; user-select:none; background:#f5f5f5;}
  h2 { margin:10px 0; }
  #touchArea { width:90%; height:300px; background:#e0e0e0; border:2px dashed #aaa; border-radius:12px; margin:20px 0; display:flex; align-items:center; justify-content:center; color:#555; font-size:18px; touch-action:none; }
  .buttons { display:flex; justify-content:space-around; width:90%; margin-bottom:10px; }
  button { width:45%; padding:15px; font-size:18px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer; }
  button:active { background:#0056b3; }
  .arrows { display:flex; justify-content:center; margin-bottom:20px; gap:10px; }
  .arrow-btn { padding:15px 20px; font-size:18px; border:none; border-radius:8px; background:#28a745; color:#fff; cursor:pointer; }
  .arrow-btn:active { background:#1e7e34; }
</style>
</head>
<body>

<h2>手机控制鼠标</h2>

<div id="touchArea">滑动此区域控制鼠标</div>

<div class="buttons">
  <button id="leftClick">左键</button>
  <button id="rightClick">右键</button>
</div>

<div class="arrows">
  <button class="arrow-btn" data-key="up">↑</button>
  <button class="arrow-btn" data-key="down">↓</button>
  <button class="arrow-btn" data-key="left">←</button>
  <button class="arrow-btn" data-key="right">→</button>
</div>

<div class="buttons">
  <button id="gyroToggle">启用陀螺仪控制</button>
</div>


<script>
  let gyroEnabled = false;
  const SENSITIVITY = 5; // 可调节


  // 封装带自动重连的 WebSocket
  function createWebSocket(url, onOpen, onMessage, onClose) {
    let ws;

    function connect() {
      ws = new WebSocket(url);

      ws.onopen = () => {
        console.log(`${url} 已连接`);
        if(onOpen) onOpen();
      };

      ws.onmessage = event => {
        if(onMessage) onMessage(event.data);
      };

      ws.onclose = () => {
        console.log(`${url} 已关闭，3秒后重连`);
        setTimeout(connect, 3000); // 3秒后重连
        if(onClose) onClose();
      };

      ws.onerror = e => {
        console.error(`${url} 出错`, e);
        ws.close(); // 出错时关闭连接，触发重连
      };
    }

    connect();

    // 提供发送函数
    return {
      send: (type, payload) => {
        if(ws.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ type, payload }));
        }
      }
    };
  }

  // 创建两个 WebSocket
  const wsMouseMove = createWebSocket(
    "ws://10.18.133.7:8000/ws/mouse_move"
  );

  const wsAction = createWebSocket(
    "ws://10.18.133.7:8000/ws/action"
  );

  // 左右键
  document.getElementById("leftClick").onclick = () => wsAction.send("mouse_click", { button:"left" });
  document.getElementById("rightClick").onclick = () => wsAction.send("mouse_click", { button:"right" });

  // 方向键
  document.querySelectorAll(".arrow-btn").forEach(btn => {
    btn.onclick = () => wsAction.send("keyboard_press", { key: btn.dataset.key });
  });

  // 鼠标移动触摸区域
  const touchArea = document.getElementById("touchArea");
  let lastX = 0, lastY = 0;
  let ticking = false;

  touchArea.addEventListener("touchstart", e => {
    const t = e.touches[0];
    lastX = t.clientX;
    lastY = t.clientY;
  });

  touchArea.addEventListener("touchmove", e => {
    e.preventDefault();
    const t = e.touches[0];
    const dx = t.clientX - lastX;
    const dy = t.clientY - lastY;
    lastX = t.clientX;
    lastY = t.clientY;

    if(!ticking){
      window.requestAnimationFrame(() => {
        wsMouseMove.send("mouse_move", { dx, dy });
        ticking = false;
      });
      ticking = true;
    }
  });

</script>
</body>
</html>